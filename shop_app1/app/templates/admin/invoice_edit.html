{% extends "base.html" %}
{% block content %}
<h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∫–ª–∞–¥–Ω–æ–π ‚Ññ {{ inv.id }}</h2>

{# üîπ –±–ª–æ–∫ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ #}
{% if error %}
  <div style="padding:10px; margin-bottom:12px; border:1px solid #f00; background:#fee; color:#900; border-radius:6px;">
    ‚ö†Ô∏è {{ error }}
  </div>
{% endif %}

<p>
  –ò–º—è: <b>{{ inv.customer_name or "‚Äî" }}</b><br>
  –¢–µ–ª–µ—Ñ–æ–Ω: <b>{{ inv.phone or "‚Äî" }}</b><br>
  –í—Ä–µ–º—è: <b>{{ inv.created_at.strftime("%Y-%m-%d %H:%M") }}</b><br>
  –ò—Ç–æ–≥–æ (—Ç–µ–∫—É—â–∏–π): <b>{{ "%.2f"|format(inv.total_amount_final) }} KZT</b>
</p>

<form method="post" action="/admin/invoices/{{ inv.id }}/update">
  <div style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">–§–æ—Ç–æ</th>
          <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
          <th style="text-align:left; border-bottom:1px solid #eee; padding:8px;">–í–∞—Ä–∏–∞–Ω—Ç</th>
          <th style="text-align:right; border-bottom:1px solid #eee; padding:8px;">–ö–æ–ª-–≤–æ</th>
          <th style="text-align:right; border-bottom:1px solid #eee; padding:8px;">–¶–µ–Ω–∞</th>
          <th style="text-align:right; border-bottom:1px solid #eee; padding:8px;">–°—É–º–º–∞</th>
          <th style="text-align:center; border-bottom:1px solid #eee; padding:8px;">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
      {% for it in items %}
        <tr>
          <td style="padding:8px; width:70px;">
            {% if it.product_image %}
              <img src="/static/uploads/products/{{ it.product_image }}" alt="" style="width:64px; height:64px; object-fit:cover; border-radius:6px;">
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td style="padding:8px;">{{ it.product_name }}</td>
          <td style="padding:8px;">{{ it.variant_name }}</td>

          <td style="padding:8px; text-align:right;">
            {% if it.qty_original != it.qty_final %}
              <div><s style="color:#999;">{{ it.qty_original }}</s> ‚Üí <b>{{ it.qty_final }}</b></div>
            {% else %}
              <div>{{ it.qty_final }}</div>
            {% endif %}
            <input type="number" name="qty_final_{{ it.id }}" value="{{ it.qty_final }}" min="0"
                   style="width:88px; padding:6px; border:1px solid #ddd; border-radius:8px; text-align:right;">
          </td>

          <td style="padding:8px; text-align:right;">
            {% if it.unit_price_original != it.unit_price_final %}
              <div>
                <s style="color:#999;">{{ "%.2f"|format(it.unit_price_original) }}</s> ‚Üí
                <b>{{ "%.2f"|format(it.unit_price_final) }}</b> KZT
              </div>
            {% else %}
              <div>{{ "%.2f"|format(it.unit_price_final) }} KZT</div>
            {% endif %}
            <input type="text" name="unit_price_final_{{ it.id }}" value="{{ "%.2f"|format(it.unit_price_final) }}"
                   style="width:100px; padding:6px; border:1px solid #ddd; border-radius:8px; text-align:right;">
          </td>

          <td style="padding:8px; text-align:right;">
            {{ "%.2f"|format(it.line_total_final) }} KZT
          </td>

          <td style="padding:8px; text-align:center;">
            <form method="post" action="/admin/invoices/{{ inv.id }}/reset-item/{{ it.id }}">
              <button type="submit" style="padding:6px 10px; border:1px solid #ddd; background:#fafafa; border-radius:8px; cursor:pointer;">
                –û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
              </button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="5" style="padding:8px; text-align:right; font-weight:700;">–ò—Ç–æ–≥–æ:</td>
          <td style="padding:8px; text-align:right; font-weight:700;">{{ "%.2f"|format(inv.total_amount_final) }} KZT</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div style="margin-top:12px;">
    <button type="submit" style="padding:8px 12px; border:1px solid #ddd; background:#f5f5f5; border-radius:8px; cursor:pointer;">
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    </button>
    <a href="/invoice/{{ inv.id }}?pkey={{ inv.pkey }}" style="margin-left:12px;">–ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞</a>
  </div>
</form>
{% endblock %}

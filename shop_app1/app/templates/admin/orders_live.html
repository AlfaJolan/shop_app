{% extends "base.html" %}
{% block content %}
<style>
  /* ---- Layout ---- */
  .toolbar {
    display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    margin: 12px 0;
  }
  .select, .btn {
    padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; background: #fff;
    font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .btn {
    cursor: pointer; transition: transform .05s ease, box-shadow .2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,.06);
  }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }

  /* ---- Grid ---- */
  .grid { display: grid; gap: 14px; grid-template-columns: 1fr; }
  @media (min-width: 700px){ .grid { grid-template-columns: repeat(2, 1fr); } }
  @media (min-width: 1024px){ .grid { grid-template-columns: repeat(3, 1fr); } }

  /* ---- Card ---- */
  .card {
    border: 1px solid #eef0f3; border-radius: 14px; background: #fff;
    box-shadow: 0 4px 16px rgba(0,0,0,.06);
    padding: 14px; transition: box-shadow .2s ease, transform .05s ease;
  }
  .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.1); transform: translateY(-2px); }

  .title { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .order-id { font-weight: 700; font-size: 15px; }
  .amount { font-weight:700; font-size:14px; }
  .meta { color:#667085; font-size: 12px; margin-bottom:2px; }
  .time { color:#475569; font-variant-numeric: tabular-nums; }

  .row, .row2 { display: grid; gap: 6px; margin-top: 4px; }
  .row2 { grid-template-columns: 1fr 1fr; }

  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .link {
    text-decoration:none; padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff;
    display:inline-flex; align-items:center; gap:6px; font-size:13px; transition: background .2s ease;
  }
  .link:hover { background:#f8fafc; }

  .empty { text-align:center; padding:24px 12px; color:#667085; }

  /* ---- Badges ---- */
  .badge {
    display:inline-flex; align-items:center; padding:6px 10px;
    border-radius:999px; font-weight:600; font-size:12px; border:1px solid transparent;
  }
  .badge.new        { background:#f1f5f9; color:#334155; border-color:#e2e8f0; }
  .badge.packed     { background:#e0f2fe; color:#075985; border-color:#bae6fd; }
  .badge.shipped    { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
  .badge.delivered  { background:#ecfdf5; color:#065f46; border-color:#bbf7d0; }
  .badge.canceled   { background:#fef2f2; color:#991b1b; border-color:#fecaca; }

  .pill {
    display:inline-block; padding:6px 10px; border-radius:999px; background:#f8fafc; border:1px solid #e2e8f0;
    font-size:12px; color:#475569;
  }

  /* ---- Skeleton ---- */
  .skeleton {
    border-radius:14px; background:linear-gradient(90deg,#f6f7f9,#eef1f5,#f6f7f9);
    background-size: 200% 100%; animation: shimmer 1.2s infinite;
    height: 110px;
  }
  @keyframes shimmer { 0%{background-position: -200% 0;} 100%{background-position: 200% 0;} }

  /* ---- Small screens ---- */
  @media (max-width: 420px){
    .order-id { font-size: 14px; }
    .badge { font-size: 11px; padding:5px 9px; }
    .link, .btn, .select { font-size: 13px; }
  }
</style>

<h2 class="mt-2">üì° –ñ–∏–≤—ã–µ –∑–∞–∫–∞–∑—ã</h2>

<div class="toolbar">
  <label for="statusFilter" class="meta">–°—Ç–∞—Ç—É—Å:</label>
  <select id="statusFilter" class="select">
    <option value="all">–í—Å–µ</option>
    {% for st in allowed_statuses %}
      <option value="{{ st }}">{{ status_labels.get(st, st) }}</option>
    {% endfor %}
  </select>
  <button id="refreshBtn" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
  <span id="lastUpd" class="pill">‚Äî</span>
</div>

<div id="ordersContainer" class="grid">
  <!-- —Å–∫–µ–ª–µ—Ç–æ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ -->
  <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
</div>

<script>
const STATUS_LABELS = {
  "new": "–ù–æ–≤—ã–π",
  "packed": "–°–æ–±—Ä–∞–Ω",
  "shipped": "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω",
  "delivered": "–ü–æ–ª—É—á–µ–Ω",
  "canceled": "–û—Ç–º–µ–Ω—ë–Ω"
};

function fmtAmount(val){
  const n = Number(val);
  return isNaN(n) ? val + " ‚Ç∏" : n.toFixed(2) + " ‚Ç∏";
}
function fmtDate(str){
  if(!str) return "‚Äî";
  const d = new Date(str);
  return isNaN(d) ? str : d.toLocaleString();
}

function el(tag, attrs={}, html=""){
  const d = document.createElement(tag);
  for (const [k,v] of Object.entries(attrs)) if (v!=null) d.setAttribute(k,v);
  if (html) d.innerHTML = html;
  return d;
}

async function fetchOrders(){
  try {
    const status = document.getElementById("statusFilter").value;
    const resp = await fetch(`/admin/orders/live-data?status=${encodeURIComponent(status)}`);
    if (!resp.ok) return;

    const data = await resp.json();
    const cont = document.getElementById("ordersContainer");
    cont.innerHTML = "";

    if (!data.length){
      cont.appendChild(el("div", {class:"empty"}, "–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä."));
    }

    data.forEach(o => {
      const card = el("div", {class:"card"});

      const header = el("div", {class:"title"});
      header.appendChild(el("div", {class:"order-id"}, `–ó–∞–∫–∞–∑ #${o.id}`));
      const badge = el("span", {class:`badge ${o.status}`}, STATUS_LABELS[o.status] || o.status);
      header.appendChild(badge);
      card.appendChild(header);

      const rowA = el("div", {class:"row2"});
      rowA.innerHTML = `
        <div><div class="meta">–ò–º—è</div><div>${o.customer_name || "‚Äî"}</div></div>
        <div><div class="meta">–¢–µ–ª–µ—Ñ–æ–Ω</div><div>${o.phone || "‚Äî"}</div></div>`;
      card.appendChild(rowA);

      if (o.comment){
        const rowB = el("div", {class:"row"});
        rowB.innerHTML = `<div><div class="meta">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div>${o.comment}</div></div>`;
        card.appendChild(rowB);
      }

      const rowC = el("div", {class:"row2", style:"align-items:end;"});
      rowC.innerHTML = `
        <div><div class="meta">–°–æ–∑–¥–∞–Ω</div><div class="time">${fmtDate(o.created_at)}</div></div>
        <div style="justify-self:end;"><div class="meta">–°—É–º–º–∞</div><div class="amount">${fmtAmount(o.total_amount)}</div></div>`;
      card.appendChild(rowC);

      const actions = el("div", {class:"actions"});
      actions.appendChild(el("a", {class:"link", href:`/admin/orders/${o.id}`}, "–û—Ç–∫—Ä—ã—Ç—å"));
      card.appendChild(actions);

      cont.appendChild(card);
    });

    document.getElementById("lastUpd").textContent =
      "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤:", e);
  }
}

document.getElementById("statusFilter").addEventListener("change", fetchOrders);
document.getElementById("refreshBtn").addEventListener("click", fetchOrders);
setInterval(fetchOrders, 5000);
fetchOrders();
</script>
{% endblock %}
